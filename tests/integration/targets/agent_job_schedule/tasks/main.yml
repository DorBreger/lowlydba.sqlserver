---
- name: Var block
  vars:
    ansible_connection: "{{ pwsh_ansible_connection }}"
    ansible_shell_type: "{{ pwsh_ansible_shell_type }}"
    forced_schedule_name: "Forced"
    job_name: "testjob"
    start_date: "20200525"
    start_time: "000000"
    frequency_type: "OnIdle"
    end_date: "20200525"
    end_time: "000929"
    start_date_result: "2020-05-25T00:00:00"
    end_date_result: "2020-05-25T00:00:00"
  module_defaults:
    lowlydba.sqlserver.agent_job_schedule:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
      start_date: "{{ start_date }}"
      start_time: "{{ start_time }}"
      end_date: "{{ end_date }}"
      end_time: "{{ end_time }}"
      frequency_type: "{{ frequency_type }}"
      job: "{{ job_name }}"
  tags: ["agent_job_schedule"]
  block:

    - name: Create job schedule with force
      lowlydba.sqlserver.agent_job_schedule:
        schedule: "{{ forced_schedule_name }}"
        force: true
        state: present
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('ScheduleUid')) != None
          - (result.data | from_json | json_query('ActiveStartDate')) == "{{ start_date_result }}"
          - (result.data | from_json | json_query('ActiveEndDate')) == "{{ end_date_result }}"
          - (result.data | from_json | json_query('JobCount')) == 1
          - (result.data | from_json | json_query('IsEnabled')) is true
          - (result.data | from_json | json_query('Name')) == "{{ forced_schedule_name }}"
          - result is changed

  # Cleanup
  always:
    - name: Remove forced job schedule
      lowlydba.sqlserver.agent_job_schedule:
        schedule: "{{ forced_schedule_name }}"
        force: true
        state: absent
