---
- name: Var block
  vars:
    ansible_connection: "{{ pwsh_ansible_connection }}"
    ansible_shell_type: "{{ pwsh_ansible_shell_type }}"
    max_memory_over_9000: 99999
  module_defaults:
    lowlydba.sqlserver.memory:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
  tags: ["memory"]
  block:

    - name: Set max memory
      lowlydba.sqlserver.memory:
        max: "{{ max_memory_over_9000 }}"
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('Total')) != None
          - (result.data | from_json | json_query('PreviousMaxValue')) is defined
          - (result.data | from_json | json_query('PreviousMaxValue')) != None
          - (result.data | from_json | json_query('MaxValue')) == {{ max_memory_over_9000 }}

    - name: Don't change max memory
      lowlydba.sqlserver.memory:
        max: "{{ max_memory_over_9000 }}"
      register: result
    - assert:
        that:
          - result is not changed

    - name: Dynamically set max memory
      lowlydba.sqlserver.memory:
        max: 0
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('PreviousMaxValue')) == {{ max_memory_over_9000 }}
          - (result.data | from_json | json_query('MaxValue')) != {{ max_memory_over_9000 }}
          - (result.data | from_json | json_query('Total'))  > (result.data | from_json | json_query('MaxValue'))
          - result is changed

    - name: Set max memory in checkmode
      lowlydba.sqlserver.memory:
        max: "{{ max_memory_over_9000 }}"
      check_mode: true
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('MaxValue')) == {{ max_memory_over_9000 }}
          - result is changed

    - name: Verify unchanged checkmode max memory
      lowlydba.sqlserver.memory:
        max: "{{ max_memory_over_9000 }}"
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('PreviousMaxValue')) != {{ max_memory_over_9000 }}
          - (result.data | from_json | json_query('MaxValue')) == {{ max_memory_over_9000 }}
          - result is changed

  always:
    - name: Dynamically set max memory
      lowlydba.sqlserver.memory:
        max: 0
