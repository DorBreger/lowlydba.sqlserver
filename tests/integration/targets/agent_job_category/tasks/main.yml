---
- name: Var block
  vars:
    ansible_connection: "{{ pwsh_ansible_connection }}"
    ansible_shell_type: "{{ pwsh_ansible_shell_type }}"
    category_name: "Integration Tests"
  module_defaults:
    lowlydba.sqlserver.agent_job_category:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
      category: "{{ category_name }}"
  tags: ["agent_job_category"]
  block:

    - name: Create job category
      lowlydba.sqlserver.agent_job_category:
      register: result
    - assert:
        that:
          - result.data != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('Name')) == "{{ category_name }}"
          - (result.data | from_json | json_query('ID')) != None
          - (result.data | from_json | json_query('CategoryType')) == "LocalJob"
          - (result.data | from_json | json_query('JobCount')) == 0

    - name: Create existing job category
      lowlydba.sqlserver.agent_job_category:
      register: result
    - assert:
        that:
          - result.data != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('Name')) == "{{ category_name }}"
          - (result.data | from_json | json_query('ID')) != None
          - (result.data | from_json | json_query('CategoryType')) == "LocalJob"
          - (result.data | from_json | json_query('JobCount')) == 0
          - result is not changed

    - name: Remove job category in check mode
      lowlydba.sqlserver.agent_job_category:
        state: absent
      register: result
      check_mode: true
    - assert:
        that:
          - result.data != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('Name')) == "{{ category_name }}"
          - (result.data | from_json | json_query('Status')) == "Dropped"
          - (result.data | from_json | json_query('IsRemoved')) is true
          - result is changed

    - name: Remove job category
      lowlydba.sqlserver.agent_job_category:
        state: absent
      register: result
    - assert:
        that:
          - result.data != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('Name')) == "{{ category_name }}"
          - (result.data | from_json | json_query('Status')) == "Dropped"
          - (result.data | from_json | json_query('IsRemoved')) is true
          - result is changed

    - name: Create new job category
      lowlydba.sqlserver.agent_job_category:
      register: result
    - assert:
        that:
          - result.data != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('Name')) == "{{ category_name }}"
          - (result.data | from_json | json_query('ID')) != None
          - (result.data | from_json | json_query('CategoryType')) == "LocalJob"
          - (result.data | from_json | json_query('JobCount')) == 0
          - result is changed

  always:
    - name: Remove job category
      lowlydba.sqlserver.agent_job_category:
        state: absent
