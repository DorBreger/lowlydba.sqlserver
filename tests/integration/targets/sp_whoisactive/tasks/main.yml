---
- name: Var block
  vars:
    ansible_connection: "{{ pwsh_ansible_connection }}"
    ansible_shell_type: "{{ pwsh_ansible_shell_type }}"
    target_database: "master"
  module_defaults:
    lowlydba.sqlserver.sp_whoisactive:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
      database: "{{ target_database }}"
  tags: ["sp_whoisactive"]
  block:

    - name: Install sp_whoisactive
      lowlydba.sqlserver.sp_whoisactive:
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('Status')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('Database')) == "{{ target_database }}"
          - (result.data | from_json | json_query('Version')) != None
          - (result.data | from_json | json_query('Status')) in ('Installed', 'Updated')
          - result is changed

    - name: Update sp_whoisactive
      lowlydba.sqlserver.sp_whoisactive:
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('Database')) == "{{ target_database }}"
          - (result.data | from_json | json_query('Version')) != None
          - (result.data | from_json | json_query('Status')) == 'Updated'
          - result is changed

    - name: Update sp_whoisactive in checkmode
      lowlydba.sqlserver.sp_whoisactive:
      register: result
      check_mode: true
    - assert:
        that:
          - (result.data | from_json | json_query('SqlInstance')) != None
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('InstanceName')) != None
          - (result.data | from_json | json_query('Database')) == "{{ target_database }}"
          - (result.data | from_json | json_query('Version')) == "n/a in check mode"
          - (result.data | from_json | json_query('Status')) == 'Updated'
          - result is changed
