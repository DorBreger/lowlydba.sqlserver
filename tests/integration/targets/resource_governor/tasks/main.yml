---
- name: Var block
  vars:
    ansible_connection: "{{ pwsh_ansible_connection }}"
    ansible_shell_type: "{{ pwsh_ansible_shell_type }}"
  module_defaults:
    lowlydba.sqlserver.resource_governor:
      sql_instance: "{{ sqlserver_instance }}"
      sql_username: "{{ sqlserver_username }}"
      sql_password: "{{ sqlserver_password }}"
  tags: ["resource_governor"]
  block:

    - name: Enable resource_governor
      lowlydba.sqlserver.resource_governor:
        enabled: true
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('Enabled')) is true
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - "'default' in (result.data | from_json | json_query('ResourcePools'))"

    - name: Disable resource_governor
      lowlydba.sqlserver.resource_governor:
        enabled: false
      register: result
    - assert:
        that:
          - (result.data | from_json | json_query('Enabled')) is false
          - (result.data | from_json | json_query('ComputerName')) != None
          - (result.data | from_json | json_query('SqlInstance')) != None
          - "'default' in (result.data | from_json | json_query('ResourcePools'))"
          - result is changed
